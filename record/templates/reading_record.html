{% extends 'base.html' %}
{% load static %}

{% block title %}
  読書記録
{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/pages/reading_record.css' %}" />
  <link rel="stylesheet" href="{% static 'css/components/review_modal.css' %}" />
  <link rel="stylesheet" href="{% static 'css/components/card.css' %}" />
  <link rel="stylesheet" href="{% static 'css/components/memo.css' %}" />
{% endblock %}

{% block js %}
  <script src="{% static 'js/review-modal.js' %}"></script>
  <script src="{% static 'js/create-memo.js' %}"></script>
{% endblock %}

{% block content %}
  <div class="page-title">読書記録</div>

  <div class="book-detail-section card">
    <div class="book-detail-left">
      <img src="{{ book.thumbnail }}" alt="{{ book.title }}" />

      <div>
        <a href="https://twitter.com/intent/tweet?text={{ book.title }}&url={{ request.build_absolute_uri|urlencode }}" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
      </div>
    </div>

    <div class="book-detail-middle">
      <h4 class="text-primary">{{ book.title }}</h4>

      <ul class="authors-container">
        {% comment %}TODO 著者名は2名までにする{% endcomment %}
        {% for author in book.authors.all %}
          <li class="author-item">
            <i class="fa-regular fa-user fa-sm"></i>
            <span>{{ author.name }}</span>
          </li>
          {% empty %}
          <li class="author-item">
            <i class="fa-regular fa-user fa-sm"></i>
            <span>-</span>
          </li>
        {% endfor %}
      </ul>

      <div class="book-buttons">
        <a href="{% url 'book_detail' book.id %}" class="btn-sm btn-info">
          <i class="fa-solid fa-book"></i>
          <span>書籍詳細へ</span>
        </a>

        {% if record.finished_at %}
          <form action="{% url 'mark_as_unfinished' book.id %}" method="post">
            {% csrf_token %}
            <button id="done-button" type="submit" class="btn-sm btn-primary w-full">
              <i class="fa-regular fa-calendar"></i>

              <span>未読にする</span>
            </button>
          </form>

          <button id="openReviewModalButton" type="button" class="btn-sm btn-primary">
            <i class="fa-solid fa-pen"></i>
            <span>レビュー</span>
          </button>
        {% endif %}
      </div>
    </div>

    {% comment %}記録{% endcomment %}
    <div class="book-detail-right">
      <h4>記録情報</h4>

      <div class="record-item">
        <div class="badge badge-info">開始日</div>
        <div class="text-sm">{{ record.started_at|default_if_none:'' }}</div>
      </div>

      <div class="record-item">
        <div class="badge badge-info">読了日</div>

        {% if record.finished_at %}
          <div class="text-sm">{{ record.finished_at }}</div>
        {% else %}
          {% if record.started_at %}
            <form action="{% url 'mark_as_finished' book.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn-sm btn-primary">
                <i class="fa-regular fa-calendar"></i>
                <span>読了済みにする</span>
              </button>
            </form>
          {% else %}
            <div class="text-sm">{{ record.finished_at|default_if_none:'-' }}</div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  {# メモの投稿フォーム #}
  <div class="memo-section card">
    <form id="memoForm" data-action="{% url 'create_memo' book.id %}">
      {% csrf_token %}
      {{ form.content }}

      {% if form.content.errors %}
        <div class="error">{{ form.content.errors }}</div>
      {% endif %}

      <button id="createMemoButton" class="btn btn-primary">
        <i class="fa-regular fa-file"></i>
        <span>メモを追加</span>
      </button>
    </form>

    <ol id="memoList">
      {% for memo in memos %}
        <li class="memo-item">
          <p>{{ memo.created_at }}</p>
          <p>{{ memo.content }}</p>
        </li>
        {% empty %}
        <p id="no-memo-title">まだメモはありません。</p>
      {% endfor %}
    </ol>
  </div>

  {% include 'review_modal.html' %}
{% endblock %}
